/**
 * @file backemf.h
 * @brief Back-EMF Sensing Module - Motor voltage measurement during coast
 *
 * Provides back-EMF (electromotive force) measurement for motor research.
 * Back-EMF is the voltage generated by a motor when it's coasting (not driven).
 * This can be used to measure motor speed, detect stalls, or study motor behavior.
 *
 * Hardware:
 * - GPIO0 (ADC1_CH0): Back-EMF input via summing circuit
 * - Summing circuit provides 1.65V bias to shift ±3.3V motor signal to 0-3.3V ADC range
 *
 * Usage:
 * - Call backemf_read() at any time to sample the current back-EMF
 * - Best results during motor coast (after PWM stops, before next activation)
 * - Can also sample during motor drive to see regenerative effects
 *
 * Note: Requires battery_monitor_init() to be called first (shared ADC1 unit)
 *
 * @date November 26, 2025
 * @author Claude Code (Anthropic)
 */

#ifndef BACKEMF_H
#define BACKEMF_H

#include <stdint.h>
#include "esp_err.h"

#ifdef __cplusplus
extern "C" {
#endif

// ============================================================================
// CONFIGURATION
// ============================================================================

/** @brief Back-EMF ADC channel (GPIO0 = ADC1_CH0) */
#define BACKEMF_GPIO            0
#define BACKEMF_ADC_CHANNEL     ADC_CHANNEL_0

/**
 * @brief Back-EMF bias voltage (1.65V offset for ±3.3V signals)
 *
 * Motor H-bridge produces -3.3V to +3.3V during coast.
 * Summing circuit with 1.65V offset shifts this to 0V to 3.3V for ADC.
 *
 * Conversion: V_motor = 2 × (V_adc - 1.65V)
 */
#define BACKEMF_BIAS_MV         1650

/**
 * @brief Suggested settle time after motor off (milliseconds)
 *
 * Back-EMF decays as motor slows down. For consistent readings:
 * - Immediate sample: Captures peak back-EMF (motor still spinning fast)
 * - After 10ms: More stable reading (motor slowing)
 * - After 50ms+: Near-zero (motor stopped or nearly stopped)
 *
 * This is just a suggestion - caller decides when to sample.
 */
#define BACKEMF_SETTLE_MS       10

// ============================================================================
// PUBLIC API
// ============================================================================

/**
 * @brief Read back-EMF voltage from motor
 *
 * @param raw_mv Output: ADC voltage in millivolts (0-3300mV range)
 * @param backemf_mv Output: Actual back-EMF in millivolts (±3300mV range)
 * @return ESP_OK on success
 * @return ESP_ERR_INVALID_STATE if ADC not initialized (call battery_monitor_init first)
 * @return ESP_FAIL on ADC read error
 *
 * Conversion formula:
 * - ADC reads 0-3.3V (after summing circuit with 1.65V bias)
 * - Actual back-EMF = 2 × (V_adc - 1.65V)
 *
 * Examples:
 * - 1650mV ADC = 0mV back-EMF (motor at rest or driven at 50% duty)
 * - 3300mV ADC = +3300mV back-EMF (motor coasting after forward drive)
 * - 0mV ADC = -3300mV back-EMF (motor coasting after reverse drive)
 *
 * Note: Can be called at any time. Caller decides when to sample based on
 * their research needs (during drive, immediately after coast, after settle, etc.)
 */
esp_err_t backemf_read(int *raw_mv, int16_t *backemf_mv);

#ifdef __cplusplus
}
#endif

#endif /* BACKEMF_H */
