; PlatformIO Project Configuration File
; EMDR Bilateral Stimulation Device
; 
; CRITICAL: This configuration enforces ESP-IDF v5.5.1 for safety-critical medical device
; DO NOT modify platform version without updating all documentation and re-validating

[platformio]
default_envs = xiao_esp32c6

[env:xiao_esp32c6]
; ========================================
; ESP-IDF VERSION ENFORCEMENT
; ========================================
; Platform version locked to ensure ESP-IDF v5.3.x compatibility
; Reference: requirements_spec.md DS001 - ESP-IDF Version Targeting
;
; ACTUAL VERSION: ESP-IDF v5.3.0 (stable and compatible)
; NOTE: v5.5.0 has component manager compatibility issues with PlatformIO
;       v5.5.1 not yet packaged by PlatformIO as of Oct 2024
;
; Package version mapping:
; - 3.50300.0 = ESP-IDF v5.3.0 (USING THIS - stable)
; - 3.50500.0 = ESP-IDF v5.5.0 (component manager issues)
platform = espressif32@6.8.1
platform_packages = 
    platformio/framework-espidf @ 3.50300.0
framework = espidf

; ========================================
; HARDWARE TARGET - SEEED XIAO ESP32-C6
; ========================================
; Using generic ESP32-C6 board with custom configuration
; Seeed Xiao ESP32-C6 specifications:
; - RISC-V 160MHz single core
; - 512KB SRAM, 4MB Flash
; - USB-C with USB Serial/JTAG
board = esp32-c6-devkitc-1

; Seeed Xiao ESP32-C6 specific overrides
board_build.mcu = esp32c6
board_build.f_cpu = 160000000L
board_build.f_flash = 80000000L
board_build.flash_mode = dio
board_build.flash_size = 4MB
board_build.partitions = default.csv

; USB Serial/JTAG configuration (Seeed Xiao uses built-in USB)
board_build.arduino.memory_type = qio_opi
board_upload.flash_size = 4MB
board_upload.maximum_size = 4194304
board_upload.maximum_ram_size = 524288

; ========================================
; SAFETY-CRITICAL BUILD FLAGS
; ========================================
; JPL Coding Standard Compliance (DS003)
build_flags = 
    ; Optimization and warnings
    -O2                          ; Optimize for performance (not -Os in development)
    -Wall                        ; All warnings
    -Wextra                      ; Extra warnings
    -Werror                      ; Treat warnings as errors
    -Wstack-usage=2048          ; Warn if stack usage exceeds 2KB
    
    ; JPL Compliance - Memory Safety
    -fstack-protector-strong     ; Stack overflow protection
    -Wformat=2                   ; Format string security
    -Wformat-overflow=2          ; Buffer overflow in printf-like functions
    -Wformat-truncation=2        ; Truncation in snprintf-like functions
    
    ; JPL Compliance - Code Quality
    -Wstrict-prototypes          ; Function prototypes required
    -Wmissing-prototypes         ; Missing function prototypes
    -Wold-style-definition       ; Old K&R style functions not allowed
    -Wimplicit-fallthrough=3     ; Switch case fallthrough detection
    
    ; Project-specific defines (ESP-IDF v5.3.0)
    -DESP_IDF_VERSION_MAJOR=5
    -DESP_IDF_VERSION_MINOR=3
    -DESP_IDF_VERSION_PATCH=0
    -DJPL_COMPLIANT_BUILD=1
    -DSAFETY_CRITICAL=1
    
    ; Development/Testing flags (comment out for production)
    -DTESTING_MODE=1
    -DENABLE_FACTORY_RESET=1
    -DDEBUG_LEVEL=3

; ========================================
; ESP-IDF SPECIFIC CONFIGURATION
; ========================================
; NimBLE is included in ESP-IDF v5.5.1 as a component
; No external libraries needed - configure via sdkconfig or menuconfig
;
; Key ESP-IDF components enabled by default:
; - bt (Bluetooth stack including NimBLE)
; - freertos (Real-time OS)
; - nvs_flash (Non-volatile storage)
; - esp_timer (Hardware timers)
; - driver (GPIO, LEDC, ADC drivers)

; ========================================
; MONITORING AND DEBUGGING
; ========================================
monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder      ; Decode crash logs
    colorize                     ; Colored output
    time                         ; Add timestamps

; Use USB Serial/JTAG (built-in to ESP32-C6)
monitor_port = /dev/ttyACM*      ; Linux/Mac
; monitor_port = COM*            ; Windows (auto-detect)

; ========================================
; UPLOAD CONFIGURATION
; ========================================
upload_speed = 921600
upload_port = /dev/ttyACM*       ; Linux/Mac
; upload_port = COM*             ; Windows (auto-detect)

; Use built-in USB Serial/JTAG for upload
upload_protocol = esptool

; ========================================
; PRODUCTION BUILD ENVIRONMENT
; ========================================
; Use this environment for final deployment
; Command: pio run -e xiao_esp32c6_production
[env:xiao_esp32c6_production]
extends = env:xiao_esp32c6

; Override testing flags for production
build_flags = 
    ${env:xiao_esp32c6.build_flags}
    -DTESTING_MODE=0             ; Disable testing mode
    -DENABLE_FACTORY_RESET=0     ; Disable factory reset in production
    -DDEBUG_LEVEL=0              ; No debug logging
    -Os                          ; Optimize for size in production

; Production optimization
build_unflags = 
    -O2                          ; Remove development optimization

; ========================================
; TESTING ENVIRONMENT
; ========================================
; Enhanced testing with more verbose output
; Command: pio run -e xiao_esp32c6_testing
[env:xiao_esp32c6_testing]
extends = env:xiao_esp32c6

build_flags = 
    ${env:xiao_esp32c6.build_flags}
    -DTESTING_MODE=1
    -DENABLE_FACTORY_RESET=1
    -DDEBUG_LEVEL=4              ; Maximum debug verbosity
    -DUNIT_TEST=1

test_framework = unity
test_build_src = yes

; ========================================
; CONFIGURATION NOTES
; ========================================
; Board Configuration:
; - Using esp32-c6-devkitc-1 as base board definition
; - Overriding with Seeed Xiao ESP32-C6 specifications
; - USB Serial/JTAG is built into ESP32-C6 (no external USB-to-Serial chip)
;
; Flash Configuration:
; - 4MB Flash (Seeed Xiao ESP32-C6 specification)
; - DIO mode (Dual I/O, faster than standard SPI)
; - 80MHz flash frequency
;
; Upload/Monitor:
; - Uses built-in USB Serial/JTAG controller
; - On Windows: Check Device Manager for COM port number
; - On Linux/Mac: Usually /dev/ttyACM0 or /dev/ttyUSB0
;
; ESP-IDF Version:
; - Will be downloaded automatically on first build
; - Look for "ESP-IDF v5.x.x" in build output
; - May take several minutes on first build
