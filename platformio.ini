; PlatformIO Project Configuration File
; EMDR Bilateral Stimulation Device
; 
; VERIFIED BUILD SUCCESS: ESP-IDF v5.5.0 with PlatformIO espressif32 v6.12.0
; Date: October 20, 2025
; Board: Seeed XIAO ESP32-C6 (officially supported)
; 
; MIGRATION NOTES:
; - Upgraded from ESP-IDF v5.3.0 → v5.5.0 (SUCCESS)
; - Required fresh PlatformIO install
; - Required: pio run -t menuconfig → Save minimal configuration
; - Build time: ~10 minutes first build, ~1 minute incremental

[platformio]
default_envs = xiao_esp32c6

[env:xiao_esp32c6]
; ========================================
; PLATFORM AND FRAMEWORK
; ========================================
; Using official PlatformIO espressif32 platform v6.12.0
; VERIFIED BUILD SUCCESS with ESP-IDF v5.5.0 (October 20, 2025)
;
; Platform v6.12.0 features:
; - Official Seeed XIAO ESP32-C6 board support (added v6.11.0)
; - ESP-IDF v5.5.0 with framework-espidf @ 3.50500.0
; - Enhanced ESP32-C6 ULP RISC-V support
; - BR/EDR (e)SCO + Wi-Fi coexistence
; - MQTT 5.0 protocol support
; - Hundreds of bug fixes from v5.3.0
;
; Reference: https://github.com/platformio/platform-espressif32/releases/tag/v6.12.0
platform = espressif32 @ 6.12.0

; ESP-IDF framework v5.5.0 (verified working)
; Platform v6.12.0 automatically selects framework-espidf @ 3.50500.0
framework = espidf

; ========================================
; HARDWARE TARGET - SEEED XIAO ESP32-C6
; ========================================
; Official board definition (added to PlatformIO in v6.11.0)
; Board name uses underscore: seeed_xiao_esp32c6
; This ensures correct pin mappings and peripheral configuration for:
; - RISC-V 160MHz high-performance core + 20MHz low-power core
; - 512KB SRAM, 4MB Flash
; - USB-C with USB Serial/JTAG
; - Correct GPIO mappings and LEDC configuration
; - ULP RISC-V coprocessor support
board = seeed_xiao_esp32c6

; Partition table
board_build.partitions = default.csv

; ========================================
; SAFETY-CRITICAL BUILD FLAGS
; ========================================
; JPL Coding Standard Compliance (DS003)
; NOTE: Some warnings downgraded to allow ESP-IDF v5.5.0 framework compilation
;       Framework has specific limitations that conflict with strict checking
build_flags = 
    ; Optimization and warnings
    -O2                          ; Optimize for performance (not -Os in development)
    -Wall                        ; All warnings
    -Wextra                      ; Extra warnings
    -Werror                      ; Treat warnings as errors
    ; -Wstack-usage=2048 removed - ESP-IDF framework has unbounded stack in some functions
    
    ; JPL Compliance - Memory Safety
    -fstack-protector-strong     ; Stack overflow protection
    -Wformat=2                   ; Format string security
    -Wformat-overflow=2          ; Buffer overflow detection
    
    ; Disable specific warnings for ESP-IDF framework components
    -Wno-format-truncation       ; ESP-IDF console component buffer sizing
    -Wno-format-nonliteral       ; ESP-IDF argtable3 dynamic format strings
    
    ; JPL Compliance - Code Quality
    ; -Wstrict-prototypes removed - C-only flag conflicts with C++ compilation
    ; -Wold-style-definition removed - conflicts with ESP-IDF framework limitations
    -Wimplicit-fallthrough=3     ; Switch case fallthrough detection
    
    ; Project-specific defines (ESP-IDF v5.5.0 - VERIFIED)
    -DESP_IDF_VERSION_MAJOR=5
    -DESP_IDF_VERSION_MINOR=5
    -DESP_IDF_VERSION_PATCH=0
    -DJPL_COMPLIANT_BUILD=1
    -DSAFETY_CRITICAL=1
    
    ; Development/Testing flags (comment out for production)
    -DTESTING_MODE=1
    -DENABLE_FACTORY_RESET=1
    -DDEBUG_LEVEL=3

; ========================================
; ESP-IDF SPECIFIC CONFIGURATION
; ========================================
; NimBLE is included in ESP-IDF v5.5.0 as a component
; No external libraries needed - configure via sdkconfig or menuconfig
;
; Key ESP-IDF v5.5.0 components enabled by default:
; - bt (Bluetooth stack including NimBLE, enhanced BR/EDR support)
; - freertos (Real-time OS)
; - nvs_flash (Non-volatile storage)
; - esp_timer (Hardware timers)
; - driver (GPIO, LEDC, ADC drivers)
; - mqtt (MQTT 5.0 protocol support)

; ========================================
; SOURCE FILE SELECTION
; ========================================
; Python script automatically selects correct source file for each environment
; This is necessary because ESP-IDF uses CMake (not PlatformIO's build_src_filter)
extra_scripts = 
    pre:scripts/select_source.py

; ========================================
; MONITORING AND DEBUGGING
; ========================================
monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder      ; Decode crash logs
    colorize                     ; Colored output
    time                         ; Add timestamps

; Use USB Serial/JTAG (built-in to ESP32-C6)
monitor_port = /dev/ttyACM*      ; Linux/Mac
; monitor_port = COM*            ; Windows (auto-detect)

; ========================================
; UPLOAD CONFIGURATION
; ========================================
upload_speed = 921600
upload_port = /dev/ttyACM*       ; Linux/Mac
; upload_port = COM*             ; Windows (auto-detect)

; Use built-in USB Serial/JTAG for upload
upload_protocol = esptool

; ========================================
; PRODUCTION BUILD ENVIRONMENT
; ========================================
; Use this environment for final deployment
; Command: pio run -e xiao_esp32c6_production
[env:xiao_esp32c6_production]
extends = env:xiao_esp32c6

; Override testing flags for production
build_flags = 
    ${env:xiao_esp32c6.build_flags}
    -DTESTING_MODE=0             ; Disable testing mode
    -DENABLE_FACTORY_RESET=0     ; Disable factory reset in production
    -DDEBUG_LEVEL=0              ; No debug logging
    -Os                          ; Optimize for size in production

; Production optimization
build_unflags = 
    ${env:xiao_esp32c6.build_unflags}
    -O2                          ; Remove development optimization

; ========================================
; TESTING ENVIRONMENT
; ========================================
; Enhanced testing with more verbose output
; Command: pio run -e xiao_esp32c6_testing
[env:xiao_esp32c6_testing]
extends = env:xiao_esp32c6

build_flags = 
    ${env:xiao_esp32c6.build_flags}
    -DTESTING_MODE=1
    -DENABLE_FACTORY_RESET=1
    -DDEBUG_LEVEL=4              ; Maximum debug verbosity
    -DUNIT_TEST=1

test_framework = unity
test_build_src = yes

; ========================================
; HARDWARE TEST ENVIRONMENTS
; ========================================
; Simple hardware validation tests - no BLE, no bilateral logic
; Each test builds only its specific test file from test/ directory

; H-Bridge Hardware Test
; Tests basic motor control: Forward -> Coast -> Reverse -> Coast
; Verifies GPIO control and MOSFET operation
; Command: pio run -e hbridge_test -t upload && pio device monitor
[env:hbridge_test]
extends = env:xiao_esp32c6

build_flags = 
    ${env:xiao_esp32c6.build_flags}
    -DHARDWARE_TEST=1            ; Flag to indicate hardware test mode
    -DDEBUG_LEVEL=3              ; Verbose logging for test observation

; Note: Source file selection handled by extra_scripts in base environment

; H-Bridge PWM Hardware Test
; Tests PWM motor control at 60% duty cycle: Forward @ 60% -> Coast -> Reverse @ 60% -> Coast
; Uses LEDC PWM: 25kHz frequency, 10-bit resolution
; Verifies smooth PWM operation and H-bridge control
; Command: pio run -e hbridge_pwm_test -t upload && pio device monitor
[env:hbridge_pwm_test]
extends = env:xiao_esp32c6

build_flags = 
    ${env:xiao_esp32c6.build_flags}
    -DHARDWARE_TEST=1            ; Flag to indicate hardware test mode
    -DDEBUG_LEVEL=3              ; Verbose logging for test observation

; Note: Source file selection handled by extra_scripts in base environment

; Minimal LEDC PWM Blink Test
; Tests basic LEDC functionality: Blink GPIO15 LED at 1Hz
; Uses LEDC PWM: 1kHz frequency, 8-bit resolution
; Purpose: Verify LEDC peripheral before H-bridge implementation
; Command: pio run -e ledc_blink_test -t upload && pio device monitor
[env:ledc_blink_test]
extends = env:xiao_esp32c6

build_flags = 
    ${env:xiao_esp32c6.build_flags}
    -DHARDWARE_TEST=1            ; Flag to indicate hardware test mode
    -DDEBUG_LEVEL=3              ; Verbose logging for test observation

; Note: Source file selection handled by extra_scripts in base environment

; Button, Deep Sleep, and Wake Hardware Test
; Tests button functionality (toggle LED), 5-second hold for deep sleep, and wake-from-sleep
; Verifies GPIO1 button input, GPIO15 LED output (active LOW), and RTC GPIO wake capability
; Test sequence:
;   1. Power on → LED ON (GPIO15 = 0)
;   2. Short press → Toggle LED
;   3. Hold 5 seconds → Countdown and enter deep sleep (<1mA)
;   4. Press button to wake → LED ON, restart cycle
; Purpose: Verify hardware before implementing program sleep/wake logic
; Command: pio run -e button_deepsleep_test -t upload && pio device monitor
[env:button_deepsleep_test]
extends = env:xiao_esp32c6

build_flags = 
    ${env:xiao_esp32c6.build_flags}
    -DHARDWARE_TEST=1            ; Flag to indicate hardware test mode
    -DDEBUG_LEVEL=3              ; Verbose logging for test observation

; Note: Source file selection handled by extra_scripts in base environment

; WS2812B LED Hardware Verification Test
; Tests WS2812B LED functionality with color cycling and deep sleep integration
; Verifies GPIO16 power enable, GPIO17 DIN control, and LED color display
; Test sequence:
;   1. Power on → WS2812B RED, GPIO15 status LED slow blink (2Hz)
;   2. Button press → Cycle colors: RED → GREEN → BLUE → RAINBOW → repeat
;   3. Each color has unique GPIO15 blink pattern for state indication
;   4. Hold button 5s → Purple blink shutdown effect, then deep sleep
;   5. Press button to wake → Returns to RED state
; Purpose: Verify WS2812B hardware before implementing therapy light features
; Command: pio run -e ws2812b_test -t upload && pio device monitor
[env:ws2812b_test]
extends = env:xiao_esp32c6

build_flags = 
    ${env:xiao_esp32c6.build_flags}
    -DHARDWARE_TEST=1            ; Flag to indicate hardware test mode
    -DDEBUG_LEVEL=3              ; Verbose logging for test observation

; Note: Source file selection handled by extra_scripts in base environment

; ULP-Coordinated H-Bridge Test (Power Efficient)
; Tests ULP (LP core) coordinated motor control with HP core light sleep
; Demonstrates battery-efficient architecture:
;   - LP core: ~100µA continuous (timing + commands)
;   - HP core: ~1-2mA light sleep, ~50mA when active for PWM
;   - Average: ~5-10mA (90% power savings vs continuous HP core)
; Uses ULP RISC-V to manage bilateral timing and wake HP core as needed
; ESP-IDF v5.5.0 includes enhanced ULP support for ESP32-C6
; Command: pio run -e ulp_hbridge_test -t upload && pio device monitor
[env:ulp_hbridge_test]
extends = env:xiao_esp32c6

build_flags = 
    ${env:xiao_esp32c6.build_flags}
    -DHARDWARE_TEST=1            ; Flag to indicate hardware test mode
    -DULP_ENABLED=1              ; Enable ULP RISC-V support
    -DDEBUG_LEVEL=3              ; Verbose logging for test observation

; IMPORTANT: Source file selection handled by scripts/select_source.py
; ESP-IDF uses CMake - build_src_filter does NOT work!
; The Python script modifies src/CMakeLists.txt before each build

; Note: ULP binary is built automatically from ulp/ulp_motor_control.c
; The ulp/CMakeLists.txt handles ULP compilation and embedding

; ========================================
; CONFIGURATION NOTES
; ========================================
; Platform Upgrade Summary (October 20, 2025):
; - Migrated from Seeed custom platform → official PlatformIO espressif32 v6.12.0
; - Upgraded ESP-IDF v5.3.0 → v5.5.0 (BUILD SUCCESS VERIFIED)
; - Seeed XIAO ESP32-C6 officially supported since platform v6.11.0
; - Enhanced ESP32-C6 ULP support added in platform v6.10.0
;
; Migration Requirements:
; - Fresh PlatformIO install (uninstall/reinstall if corrupted)
; - Run: pio run -t menuconfig → Save minimal configuration
; - First build downloads ~1GB (framework + toolchains)
; - First build time: ~10 minutes
; - Subsequent builds: ~1 minute
;
; Board Configuration:
; - Using official seeed_xiao_esp32c6 board definition
; - Includes correct specifications for Seeed Xiao ESP32-C6
; - USB Serial/JTAG is built into ESP32-C6 (no external USB-to-Serial chip)
;
; Flash Configuration:
; - 4MB Flash (Seeed Xiao ESP32-C6 specification)
; - DIO mode (Dual I/O, faster than standard SPI)
; - 80MHz flash frequency
;
; Upload/Monitor:
; - Uses built-in USB Serial/JTAG controller
; - On Windows: Check Device Manager for COM port number
; - On Linux/Mac: Usually /dev/ttyACM0 or /dev/ttyUSB0
;
; ESP-IDF v5.5.0 New Features:
; - BR/EDR (e)SCO and Wi-Fi coexistence support
; - Hands-Free Profile (HFP) for AG and HF roles
; - Full MQTT 5.0 protocol support
; - Enhanced ESP32-C6 ULP RISC-V support
; - Improved Wi-Fi 6 performance
; - Hundreds of bug fixes from v5.3.0
;
; Build Results (October 20, 2025):
; - RAM Usage: 3.1% (10,148 bytes / 327,680 bytes)
; - Flash Usage: 4.1% (168,667 bytes / 4,128,768 bytes)
; - Build Time: 610 seconds (10 minutes) first build
; - Platform: espressif32 @ 6.12.0
; - Framework: framework-espidf @ 3.50500.0 (5.5.0)
;
; JPL Compliance Note:
; - Some warnings downgraded to allow ESP-IDF v5.5.0 framework compilation
; - All application code still requires function prototypes and modern C99 style
; - Framework has specific limitations that conflict with strict checking
; - Stack protection and memory safety flags remain enforced
