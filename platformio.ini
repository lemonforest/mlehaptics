; PlatformIO Project Configuration File
; EMDR Bilateral Stimulation Device
; 
; CRITICAL: This configuration uses ESP-IDF v5.3.0 for safety-critical medical device
; v5.3.0 is the highest stable version with full PlatformIO compatibility
; DO NOT modify platform version without updating all documentation and re-validating

[platformio]
default_envs = xiao_esp32c6

[env:xiao_esp32c6]
; ========================================
; ESP-IDF VERSION ENFORCEMENT
; ========================================
; Platform version locked to ensure ESP-IDF v5.3.0 compatibility
; Reference: requirements_spec.md DS001 - ESP-IDF Version Targeting
;
; IMPORTANT: Using Seeed Studio's official board definition
; Reference: https://wiki.seeedstudio.com/xiao_esp32c6_with_platform_io/
;
; The Seeed platform includes proper board configuration for:
; - RISC-V 160MHz single core
; - 512KB SRAM, 4MB Flash
; - USB-C with USB Serial/JTAG
; - Correct GPIO mappings and LEDC configuration
platform = https://github.com/Seeed-Studio/platform-seeedboards.git
platform_packages = 
    platformio/framework-espidf @ 3.50300.0
framework = espidf

; ========================================
; HARDWARE TARGET - SEEED XIAO ESP32-C6
; ========================================
; Using official Seeed Studio board definition
; This ensures correct pin mappings and peripheral configuration
board = seeed-xiao-esp32-c6

; Partition table
board_build.partitions = default.csv

; ========================================
; SAFETY-CRITICAL BUILD FLAGS
; ========================================
; JPL Coding Standard Compliance (DS003)
; NOTE: Some warnings downgraded to allow ESP-IDF v5.3.0 framework compilation
;       Framework has specific limitations that conflict with strict checking
build_flags = 
    ; Optimization and warnings
    -O2                          ; Optimize for performance (not -Os in development)
    -Wall                        ; All warnings
    -Wextra                      ; Extra warnings
    -Werror                      ; Treat warnings as errors
    ; -Wstack-usage=2048 removed - ESP-IDF framework has unbounded stack in some functions
    
    ; JPL Compliance - Memory Safety
    -fstack-protector-strong     ; Stack overflow protection
    -Wformat=2                   ; Format string security
    -Wformat-overflow=2          ; Buffer overflow detection
    
    ; Disable specific warnings for ESP-IDF framework components
    -Wno-format-truncation       ; ESP-IDF console component buffer sizing
    -Wno-format-nonliteral       ; ESP-IDF argtable3 dynamic format strings
    
    ; JPL Compliance - Code Quality
    ; -Wstrict-prototypes removed - C-only flag conflicts with C++ compilation
    ; -Wold-style-definition removed - conflicts with ESP-IDF v5.3.0 framework bugs
    -Wimplicit-fallthrough=3     ; Switch case fallthrough detection
    
    ; Project-specific defines (ESP-IDF v5.3.0)
    -DESP_IDF_VERSION_MAJOR=5
    -DESP_IDF_VERSION_MINOR=3
    -DESP_IDF_VERSION_PATCH=0
    -DJPL_COMPLIANT_BUILD=1
    -DSAFETY_CRITICAL=1
    
    ; Development/Testing flags (comment out for production)
    -DTESTING_MODE=1
    -DENABLE_FACTORY_RESET=1
    -DDEBUG_LEVEL=3

; ========================================
; ESP-IDF SPECIFIC CONFIGURATION
; ========================================
; NimBLE is included in ESP-IDF v5.3.0 as a component
; No external libraries needed - configure via sdkconfig or menuconfig
;
; Key ESP-IDF components enabled by default:
; - bt (Bluetooth stack including NimBLE)
; - freertos (Real-time OS)
; - nvs_flash (Non-volatile storage)
; - esp_timer (Hardware timers)
; - driver (GPIO, LEDC, ADC drivers)

; ========================================
; SOURCE FILE SELECTION
; ========================================
; Python script automatically selects correct source file for each environment
; This is necessary because ESP-IDF uses CMake (not PlatformIO's build_src_filter)
extra_scripts = 
    pre:scripts/select_source.py

; ========================================
; MONITORING AND DEBUGGING
; ========================================
monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder      ; Decode crash logs
    colorize                     ; Colored output
    time                         ; Add timestamps

; Use USB Serial/JTAG (built-in to ESP32-C6)
monitor_port = /dev/ttyACM*      ; Linux/Mac
; monitor_port = COM*            ; Windows (auto-detect)

; ========================================
; UPLOAD CONFIGURATION
; ========================================
upload_speed = 921600
upload_port = /dev/ttyACM*       ; Linux/Mac
; upload_port = COM*             ; Windows (auto-detect)

; Use built-in USB Serial/JTAG for upload
upload_protocol = esptool

; ========================================
; PRODUCTION BUILD ENVIRONMENT
; ========================================
; Use this environment for final deployment
; Command: pio run -e xiao_esp32c6_production
[env:xiao_esp32c6_production]
extends = env:xiao_esp32c6

; Override testing flags for production
build_flags = 
    ${env:xiao_esp32c6.build_flags}
    -DTESTING_MODE=0             ; Disable testing mode
    -DENABLE_FACTORY_RESET=0     ; Disable factory reset in production
    -DDEBUG_LEVEL=0              ; No debug logging
    -Os                          ; Optimize for size in production

; Production optimization
build_unflags = 
    ${env:xiao_esp32c6.build_unflags}
    -O2                          ; Remove development optimization

; ========================================
; TESTING ENVIRONMENT
; ========================================
; Enhanced testing with more verbose output
; Command: pio run -e xiao_esp32c6_testing
[env:xiao_esp32c6_testing]
extends = env:xiao_esp32c6

build_flags = 
    ${env:xiao_esp32c6.build_flags}
    -DTESTING_MODE=1
    -DENABLE_FACTORY_RESET=1
    -DDEBUG_LEVEL=4              ; Maximum debug verbosity
    -DUNIT_TEST=1

test_framework = unity
test_build_src = yes

; ========================================
; HARDWARE TEST ENVIRONMENTS
; ========================================
; Simple hardware validation tests - no BLE, no bilateral logic
; Each test builds only its specific test file from test/ directory

; H-Bridge Hardware Test
; Tests basic motor control: Forward -> Coast -> Reverse -> Coast
; Verifies GPIO control and MOSFET operation
; Command: pio run -e hbridge_test -t upload && pio device monitor
[env:hbridge_test]
extends = env:xiao_esp32c6

build_flags = 
    ${env:xiao_esp32c6.build_flags}
    -DHARDWARE_TEST=1            ; Flag to indicate hardware test mode
    -DDEBUG_LEVEL=3              ; Verbose logging for test observation

; Note: Source file selection handled by extra_scripts in base environment

; H-Bridge PWM Hardware Test
; Tests PWM motor control at 60% duty cycle: Forward @ 60% -> Coast -> Reverse @ 60% -> Coast
; Uses LEDC PWM: 25kHz frequency, 10-bit resolution
; Verifies smooth PWM operation and H-bridge control
; Command: pio run -e hbridge_pwm_test -t upload && pio device monitor
[env:hbridge_pwm_test]
extends = env:xiao_esp32c6

build_flags = 
    ${env:xiao_esp32c6.build_flags}
    -DHARDWARE_TEST=1            ; Flag to indicate hardware test mode
    -DDEBUG_LEVEL=3              ; Verbose logging for test observation

; Note: Source file selection handled by extra_scripts in base environment

; Minimal LEDC PWM Blink Test
; Tests basic LEDC functionality: Blink GPIO15 LED at 1Hz
; Uses LEDC PWM: 1kHz frequency, 8-bit resolution
; Purpose: Verify LEDC peripheral before H-bridge implementation
; Command: pio run -e ledc_blink_test -t upload && pio device monitor
[env:ledc_blink_test]
extends = env:xiao_esp32c6

build_flags = 
    ${env:xiao_esp32c6.build_flags}
    -DHARDWARE_TEST=1            ; Flag to indicate hardware test mode
    -DDEBUG_LEVEL=3              ; Verbose logging for test observation

; Note: Source file selection handled by extra_scripts in base environment

; ULP-Coordinated H-Bridge Test (Power Efficient)
; Tests ULP (LP core) coordinated motor control with HP core light sleep
; Demonstrates battery-efficient architecture:
;   - LP core: ~100ÂµA continuous (timing + commands)
;   - HP core: ~1-2mA light sleep, ~50mA when active for PWM
;   - Average: ~5-10mA (90% power savings vs continuous HP core)
; Uses ULP RISC-V to manage bilateral timing and wake HP core as needed
; Command: pio run -e ulp_hbridge_test -t upload && pio device monitor
[env:ulp_hbridge_test]
extends = env:xiao_esp32c6

build_flags = 
    ${env:xiao_esp32c6.build_flags}
    -DHARDWARE_TEST=1            ; Flag to indicate hardware test mode
    -DULP_ENABLED=1              ; Enable ULP RISC-V support
    -DDEBUG_LEVEL=3              ; Verbose logging for test observation

; IMPORTANT: Source file selection handled by scripts/select_source.py
; ESP-IDF uses CMake - build_src_filter does NOT work!
; The Python script modifies src/CMakeLists.txt before each build

; Note: ULP binary is built automatically from ulp/ulp_motor_control.c
; The ulp/CMakeLists.txt handles ULP compilation and embedding

; ========================================
; CONFIGURATION NOTES
; ========================================
; Board Configuration:
; - Using esp32-c6-devkitc-1 as base board definition
; - Overriding with Seeed Xiao ESP32-C6 specifications
; - USB Serial/JTAG is built into ESP32-C6 (no external USB-to-Serial chip)
;
; Flash Configuration:
; - 4MB Flash (Seeed Xiao ESP32-C6 specification)
; - DIO mode (Dual I/O, faster than standard SPI)
; - 80MHz flash frequency
;
; Upload/Monitor:
; - Uses built-in USB Serial/JTAG controller
; - On Windows: Check Device Manager for COM port number
; - On Linux/Mac: Usually /dev/ttyACM0 or /dev/ttyUSB0
;
; ESP-IDF Version:
; - ESP-IDF v5.3.0 (stable, tested, full PlatformIO compatibility)
; - Will be downloaded automatically on first build
; - May take several minutes on first build
;
; JPL Compliance Note:
; - -Wmissing-prototypes not treated as error due to ESP-IDF framework requirements
; - -Wold-style-definition removed entirely due to multiple ESP-IDF v5.3.0 framework bugs
; - All application code still requires function prototypes and modern C99 style
; - Framework bugs: flash_encrypt.c, bootloader_flash_config_esp32c6.c
